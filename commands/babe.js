const axios = require('axios');
const { sendMessage } = require('../handles/sendMessage');
const sessionHistory = {}; // In-memory storage for session histories

module.exports = {
  name: 'babe',
  description: 'Interact with Jea AI, the personal AI Girlfriend',
  usage: "/babe hi",
  author: 'Biru',
  async execute(senderId, args, pageAccessToken) {
    const prompt = args.join(' ');

    if (!prompt) {
      return sendMessage(senderId, { text: 'Please provide a prompt, for example: babe How are you?' }, pageAccessToken);
    }

    // Initialize user session if not exists
    if (!sessionHistory[senderId]) {
      sessionHistory[senderId] = {
        id: `session-${senderId}-${Date.now()}`, // Unique session ID for each user
        messages: [] // Message history
      };
    }

    // Add user message to session history
    sessionHistory[senderId].messages.push({
      id: `msg-${Date.now()}`,
      content: prompt,
      role: 'user'
    });

    const headers = {
      "Content-Type": "application/json",
      "Origin": "https://www.blackbox.ai",
      "Referer": "https://www.blackbox.ai/agent/BabeOB4l1nK",
      "User-Agent": "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Mobile Safari/537.36"
    };

    const config = {
      "messages": sessionHistory[senderId].messages, // Send entire message history
      "id": sessionHistory[senderId].id, // User's session ID
      "previewToken": null,
      "userId": senderId, // User ID for personalization
      "codeModelMode": true,
      "userSelectedModel: "blackboxai-pro",
      "agentMode": {
        "mode": true,
        "id": "BabeOB4l1nK",
        "name": "Babe"
      },
      "trendingAgentMode": {},
      "isMicMode": false,
      "maxTokens": 1024,
      "isChromeExt": false,
      "githubToken": null,
      "clickedAnswer2": false,
      "clickedAnswer3": false,
      "clickedForceWebSearch": false,
      "visitFromDelta": false,
      "mobileClient": false,
      "withCredentials": true
    };

    const apiUrl = 'https://www.blackbox.ai/api/chat';

    try {
      const response = await axios.post(apiUrl, config, { headers });
      let jeaResponse = response.data;

      // Remove unwanted string
      jeaResponse = jeaResponse.replace("Generated by BLACKBOX.AI, try unlimited chat https://www.blackbox.ai", "");

      // Add bot's response to session history
      sessionHistory[senderId].messages.push({
        id: `msg-${Date.now()}`,
        content: jeaResponse,
        role: 'assistant'
      });

      const formattedResponse = 
`BABE üñ§\n\n${jeaResponse}`;

      await sendMessage(senderId, { text: formattedResponse }, pageAccessToken);

    } catch (error) {
      console.error('Error:', error);

      await sendMessage(senderId, { text: '‚ùå An error occurred. Please try again later.' }, pageAccessToken);
    }
  }
};
